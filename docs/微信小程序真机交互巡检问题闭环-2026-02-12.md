# 微信小程序真机交互巡检问题闭环（2026-02-12）

## 1. 巡检范围与基线
- 巡检日期：2026-02-12
- 目标端：微信小程序（`mp-weixin`）
- 项目：`campus-errand-uniapp`
- 构建校验：`npm run build:mp-weixin`（通过）
- 路由校验：页面跳转路由与 `pages.json` 声明一致（无缺失）

## 2. 交互巡检清单（本轮）
- 登录链路：协议勾选、微信登录按钮、游客进入、弹窗交互
- 首页链路：定位切换、搜索入口、推荐任务、接单确认弹窗
- 任务链路：任务列表筛选/下拉刷新/分页、任务详情状态流转
- 订单链路：角色切换、状态筛选、取消/确认收货/确认送达、评价跳转
- 消息链路：类型筛选、未读统计、一键已读、消息已读状态同步
- 用户链路：个人中心、钱包、支付密码、交易明细、实名认证
- 地图链路：地图定位、附近地点、地址确认回传
- 通用链路：静态资源引用、样式兼容性（小程序端 API 参数兼容）

## 3. 问题闭环明细

### P1-01 地图页依赖占位 KEY，真机上逆地理/POI 查询失效
- 现象：
  - `location.vue` 使用占位 key，导致地址反查与附近地点为空。
  - 用户在未配置 key 的环境下无法完整完成地图选址。
- 根因：
  - 地图 WebService key 未注入时无降级策略。
- 修复：
  - 增加 `hasMapKey` 判断，未配置 key 时进入“基础定位模式”。
  - 反查/附近搜索改为坐标兜底；搜索操作降级到 `uni.chooseLocation`。
  - 文件：`campus-errand-uniapp/src/package-map/pages/map/location.vue`
- 复测：
  - `mp-weixin` 构建通过；
  - 未配 key 时可定位、可选点、可确认回传地址（坐标兜底）。

### P1-02 地图标记资源缺失，marker 不可见
- 现象：
  - `iconPath: '/static/images/marker.png'` 指向文件不存在。
- 根因：
  - 静态资源未落库。
- 修复：
  - 新增 marker 图标资源：
  - 文件：`campus-errand-uniapp/src/static/images/marker.png`
- 复测：
  - 静态资源引用检查通过；
  - 小程序构建通过。

### P1-03 默认头像资源缺失，订单/评价页头像回退失效
- 现象：
  - `/static/avatar/default.png` 被引用但文件缺失，导致默认头像不显示。
- 根因：
  - 静态默认资源未提供。
- 修复：
  - 新增默认头像资源：
  - 文件：`campus-errand-uniapp/src/static/avatar/default.png`
- 复测：
  - 静态资源引用检查通过；
  - 订单列表与评价列表 fallback 路径可命中资源。

### P1-04 钱包页分包跳转路径错误
- 现象：
  - 钱包页“明细/支付密码”跳转使用主包路径，可能导致页面不存在。
- 根因：
  - 分包页面地址写成 `/pages/user/...`。
- 修复：
  - 改为分包路径：
  - `'/package-user/pages/user/transactions'`
  - `'/package-user/pages/user/pay-password'`
  - 文件：`campus-errand-uniapp/src/package-user/pages/user/wallet.vue`
- 复测：
  - 路由声明校验通过（无缺失路由引用）；
  - 构建通过。

### P2-01 列表页返回刷新不稳定（订单/消息）
- 现象：
  - 部分场景下从子页返回后列表刷新行为不一致，分页状态可能污染。
- 根因：
  - 刷新入口分散，存在“分页状态未重置”路径。
- 修复：
  - 抽离 `refreshList()`，统一重置 `current/noMore` 后加载。
  - 操作成功后（取消、确认）强制列表重新拉取第一页。
  - 文件：
    - `campus-errand-uniapp/src/pages/order/list.vue`
    - `campus-errand-uniapp/src/pages/message/list.vue`
- 复测：
  - 下拉刷新、返回页刷新、操作后刷新路径一致。

### P2-02 小程序原生弹窗 confirmColor 使用 CSS 变量兼容风险
- 现象：
  - `uni.showModal` 的 `confirmColor` 使用 `var(--color-primary)`，小程序端不稳定。
- 根因：
  - 原生 API 颜色参数应使用具体色值。
- 修复：
  - 改为十六进制色值 `#f59e0b`。
  - 文件：
    - `campus-errand-uniapp/src/pages/index/index.vue`
    - `campus-errand-uniapp/src/pages/login/index.vue`
- 复测：
  - 构建通过，参数符合小程序 API 使用习惯。

### P3-01 登录按钮内联 SVG 在小程序端兼容性风险
- 现象：
  - 登录页按钮内联 SVG 在不同基础库上存在渲染差异风险。
- 根因：
  - 小程序端复杂内联 SVG 兼容性不如普通文本/图片稳定。
- 修复：
  - 使用轻量文本图标替代内联 SVG。
  - 文件：`campus-errand-uniapp/src/pages/login/index.vue`
- 复测：
  - 构建通过，按钮视觉正常。

## 4. 本轮复测结果
- `npm run build:mp-weixin`：通过（无阻断错误）
- 路由声明一致性检查：通过（无缺失路由）
- 静态资源引用检查：通过（无缺失静态文件）

## 5. 未关闭项（非阻断）
- Sass 弃用告警仍存在（`@import` 与 legacy-js-api）：
  - 当前不阻断交付与真机运行；
  - 建议后续单独迁移为 `@use/@forward`，减少未来升级风险。

## 6. 真机回归建议（验收脚本）
1. 登录页：协议弹窗、游客模式、微信登录按钮态。
2. 首页：定位切换、推荐任务“立即接单”弹窗按钮色。
3. 任务列表：筛选切换、下拉刷新、上拉分页。
4. 订单列表：角色切换、取消/确认按钮后刷新。
5. 消息页：一键已读后未读角标变化。
6. 钱包页：进入“交易明细”“支付密码”页面是否正常。
7. 地图页：未配 key 场景下是否可通过基础定位模式完成地址选择与回传。
