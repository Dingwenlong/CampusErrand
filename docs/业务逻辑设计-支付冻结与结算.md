# 校园跑腿系统 - 支付冻结与结算业务逻辑设计

## 一、业务概述

本系统采用"资金冻结"机制确保交易安全。用户发布任务时，系统会冻结相应金额，待任务完成后再进行实际的资金划转。

---

## 二、核心业务流程

### 2.1 任务发布支付流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户发布任务  │ --> │  验证支付密码  │ --> │  检查余额充足  │
└─────────────┘     └─────────────┘     └─────────────┘
                                                │
                                                v
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  创建任务记录  | <-- │  记录交易流水  | <-- │  冻结任务金额  │
└─────────────┘     └─────────────┘     └─────────────┘
```

**详细步骤：**

1. **用户发起发布任务请求**
   - 请求参数：任务信息 + 支付密码

2. **系统验证支付密码**
   - 使用 MD5 加密比对
   - 错误则返回"支付密码错误"

3. **检查余额充足性**
   - 条件：`可用余额 = 余额 - 冻结金额 >= 任务总金额`
   - 不足则返回"余额不足，请先充值"

4. **冻结任务金额**
   - 更新 `tb_user_wallet.frozen_amount += 任务总金额`
   - 原子操作，防止并发问题

5. **记录交易流水**
   - 插入 `tb_transaction` 记录
   - 类型：任务支付（支出）
   - 状态：处理中（冻结状态）

6. **创建任务记录**
   - 插入 `tb_task` 记录
   - 状态：待接单（status = 0）

---

### 2.2 任务完成结算流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  确认任务完成  │ --> │  解冻任务金额  │ --> │  扣除发单者余额 │
└─────────────┘     └─────────────┘     └─────────────┘
                                                │
                                                v
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  记录双方流水  | <-- │  增加跑腿员余额 | <-- │  平台抽成(可选) │
└─────────────┘     └─────────────┘     └─────────────┘
```

**详细步骤：**

1. **确认任务完成**
   - 发单者点击"确认完成"
   - 或系统自动确认（超时机制）

2. **解冻任务金额**
   - 更新 `tb_user_wallet.frozen_amount -= 任务总金额`

3. **扣除发单者余额**
   - 更新 `tb_user_wallet.balance -= 任务总金额`

4. **平台抽成（可选）**
   - 平台服务费 = 任务总金额 * 抽成比例（如 5%）
   - 实际到账 = 任务总金额 - 平台服务费

5. **增加跑腿员余额**
   - 更新跑腿员 `tb_user_wallet.balance += 实际到账`
   - 更新跑腿员 `tb_user_wallet.total_income += 实际到账`

6. **记录双方交易流水**
   - 发单者流水：任务支付（支出）- 状态：成功
   - 跑腿员流水：任务收入（收入）- 状态：成功

---

## 三、数据库表设计

### 3.1 用户钱包表 (tb_user_wallet)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID |
| balance | DECIMAL(10,2) | 余额 |
| frozen_amount | DECIMAL(10,2) | 冻结金额 |
| total_income | DECIMAL(10,2) | 累计收入 |
| total_expense | DECIMAL(10,2) | 累计支出 |
| pay_password | VARCHAR(64) | 支付密码(MD5加密) |

### 3.2 交易流水表 (tb_transaction)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| transaction_no | VARCHAR(32) | 交易流水号 |
| user_id | BIGINT | 用户ID |
| direction | TINYINT | 方向：1-收入 2-支出 |
| transaction_type | TINYINT | 类型：1-充值 2-提现 3-任务支付 4-任务收入 5-退款 |
| amount | DECIMAL(10,2) | 金额 |
| balance | DECIMAL(10,2) | 交易后余额 |
| related_id | BIGINT | 关联ID（任务ID等）|
| status | TINYINT | 状态：0-处理中 1-成功 2-失败 |
| remark | VARCHAR(255) | 备注 |
| create_time | DATETIME | 创建时间 |

### 3.3 任务表 (tb_task)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 发单者ID |
| runner_id | BIGINT | 跑腿员ID |
| total_amount | DECIMAL(10,2) | 任务总金额 |
| status | TINYINT | 状态：0-待接单 1-已接单 2-待取件 3-配送中 4-待确认 5-已完成 6-已取消 |
| ... | ... | 其他字段 |

---

## 四、关键接口设计

### 4.1 发布任务（带支付）

```
POST /task/publish

Request:
{
    "title": "帮忙取快递",
    "taskType": 1,
    "pickupAddress": "菜鸟驿站",
    "deliveryAddress": "3号楼301",
    "reward": 5.00,
    "weightFee": 0,
    "urgencyFee": 0,
    "payPassword": "123456"
}

Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "title": "帮忙取快递",
        "status": 0,
        "totalAmount": 5.00
    }
}
```

### 4.2 确认任务完成

```
POST /task/{id}/complete

Response:
{
    "code": 200,
    "message": "success",
    "data": true
}
```

---

## 五、异常处理

| 异常场景 | 处理方式 |
|----------|----------|
| 支付密码错误 | 返回错误信息，记录失败日志 |
| 余额不足 | 返回"余额不足"，引导用户充值 |
| 任务取消 | 解冻金额，记录退款流水 |
| 并发抢单 | Redis分布式锁，确保数据一致性 |
| 系统异常 | 事务回滚，保证数据完整性 |

---

## 六、安全考虑

1. **支付密码加密**：使用 MD5 + Salt 加密存储
2. **事务控制**：使用 @Transactional 确保原子性
3. **并发控制**：使用数据库乐观锁或 Redis 分布式锁
4. **幂等性**：交易流水号唯一，防止重复处理
5. **金额精度**：使用 DECIMAL 类型，避免浮点误差

---

## 七、待优化项

1. 接入真实微信支付
2. 增加支付风控（异常检测）
3. 支持批量结算
4. 增加资金对账功能
